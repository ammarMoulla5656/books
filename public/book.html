<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØªØ§Ø¨ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©">
    <meta name="theme-color" content="#f5f5f0">

    <title>Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØªØ§Ø¨ - Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</title>

    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Ø§Ù„Ø£Ù†Ù…Ø§Ø· -->
    <link rel="stylesheet" href="/css/themes.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/book-reader.css">
    <link rel="stylesheet" href="/css/context-menu.css">
    <link rel="stylesheet" href="/css/text-finder.css">
    <link rel="stylesheet" href="/css/smart-fetch.css">
    <link rel="stylesheet" href="/css/ai-chat.css">

    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body class="book-reader-page">
    <!-- Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© -->
    <div class="reading-progress">
        <div class="reading-progress-bar" id="reading-progress-bar"></div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <header class="navbar">
        <div class="navbar-container">
            <div class="navbar-right">
                <a href="/" class="navbar-brand">
                    <span class="navbar-logo">ğŸ“š</span>
                    <span class="navbar-brand-text">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</span>
                </a>

                <div class="book-info-mini" id="book-info-mini">
                    <span class="book-title-mini" id="book-title-mini">Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</span>
                </div>
            </div>

            <div class="navbar-actions">
                <button class="theme-toggle" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…" id="theme-toggle">
                    <span class="theme-toggle-sun">â˜€ï¸</span>
                    <span class="theme-toggle-moon">ğŸŒ™</span>
                </button>

                <button class="btn btn-ghost btn-icon sidebar-toggle-btn" data-action="toggle-sidebar" title="Ø§Ù„ÙÙ‡Ø±Ø³">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="book-layout">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ - Ø§Ù„ÙÙ‡Ø±Ø³ -->
        <aside class="book-sidebar" id="book-sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">ÙÙ‡Ø±Ø³ Ø§Ù„ÙƒØªØ§Ø¨</h2>
                <button class="btn btn-ghost btn-icon-sm sidebar-close" data-action="toggle-sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="sidebar-content">
                <nav class="book-toc" id="book-toc">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                </nav>
            </div>

            <div class="sidebar-footer">
                <div class="book-progress">
                    <div class="progress-label">ØªÙ‚Ø¯Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0%</div>
                </div>
            </div>
        </aside>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© -->
        <main class="book-main">
            <div class="book-container">
                <!-- Breadcrumb -->
                <nav class="breadcrumb" id="breadcrumb">
                    <div class="breadcrumb-item">
                        <a href="/" class="breadcrumb-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                        <span class="breadcrumb-separator">/</span>
                    </div>
                    <div class="breadcrumb-item">
                        <span class="breadcrumb-current" id="breadcrumb-book">Ø§Ù„ÙƒØªØ§Ø¨</span>
                    </div>
                </nav>

                <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØªØ§Ø¨ -->
                <article class="book-content reading-content" id="book-content">
                    <div class="book-loading">
                        <div class="spinner spinner-lg"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨...</p>
                    </div>
                </article>
            </div>
        </main>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
    <div class="toolbar">
        <button class="toolbar-btn" id="font-decrease" title="ØªØµØºÙŠØ± Ø§Ù„Ø®Ø·">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="8" y1="11" x2="14" y2="11"></line>
            </svg>
        </button>

        <button class="toolbar-btn" id="font-increase" title="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø·">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="11" y1="8" x2="11" y2="14"></line>
                <line x1="8" y1="11" x2="14" y2="11"></line>
            </svg>
        </button>

        <div class="toolbar-divider"></div>

        <button class="toolbar-btn" id="goto-first" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="11 17 6 12 11 7"></polyline>
                <polyline points="18 17 13 12 18 7"></polyline>
            </svg>
        </button>

        <button class="toolbar-btn" id="goto-last" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="13 17 18 12 13 7"></polyline>
                <polyline points="6 17 11 12 6 7"></polyline>
            </svg>
        </button>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø± Ø§Ù„ÙŠÙ…ÙŠÙ† -->
    <div id="contextMenu" class="context-menu" style="display: none;">
        <ul>
            <li onclick="searchSelectedText()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Ø£ÙŠÙ† ÙˆØ±Ø¯ Ø§Ù„Ù†ØµØŸ
            </li>
            <li onclick="smartFetchSelected()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙƒÙŠ
            </li>
            <li onclick="openAIChatWithText()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                Ø§Ø³Ø£Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
            </li>
            <li onclick="addBookmark()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
                Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù…Ø±Ø¬Ø¹ÙŠØ©
            </li>
        </ul>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Øµ -->
    <div id="textFinderModal" class="modal" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Ø£ÙŠÙ† ÙˆØ±Ø¯ Ø§Ù„Ù†ØµØŸ</h3>
                <button class="modal-close" onclick="closeTextFinder()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <input type="text" id="searchTextInput" class="form-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨..." />
                    <button class="btn btn-primary" onclick="performTextSearch()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        Ø¨Ø­Ø«
                    </button>
                </div>
                <div id="textFinderResults" class="search-results"></div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ -->
    <div id="smartFetchModal" class="modal" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙƒÙŠ</h3>
                <button class="modal-close" onclick="closeSmartFetch()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <input type="text" id="smartFetchInput" class="form-input" placeholder="Ø§Ø³Ø£Ù„ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¶ÙˆØ¹..." />
                    <button class="btn btn-primary" onclick="performSmartFetch()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Ø¬Ù„Ø¨
                    </button>
                </div>
                <div id="smartFetchResults" class="search-results"></div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ© -->
    <div id="aiChatModal" class="modal" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                <button class="modal-close" onclick="closeAIChat()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="aiChatMessages" class="chat-messages"></div>
                <div class="chat-input-box">
                    <input type="text" id="aiChatInput" class="form-input" placeholder="Ø§Ø³Ø£Ù„ Ø³Ø¤Ø§Ù„Ø§Ù‹..." onkeypress="if(event.key==='Enter') sendAIMessage()" />
                    <button class="btn btn-primary" onclick="sendAIMessage()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        Ø¥Ø±Ø³Ø§Ù„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù† URL
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('id');

        if (!bookId) {
            window.location.href = '/';
        }

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let book = null;
        let allSections = [];
        let currentSectionIndex = 0;
        let fontSize = 1.25;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
        async function loadBook() {
            try {
                const response = await fetch(`/api/books/${bookId}`);
                if (!response.ok) {
                    throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨');
                }

                book = await response.json();

                // ØªØ³Ø·ÙŠØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                allSections = [];
                book.chapters.forEach(chapter => {
                    chapter.sections.forEach(section => {
                        allSections.push({
                            ...section,
                            chapterTitle: chapter.title,
                            chapterId: chapter.id
                        });
                    });
                });

                // Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ§Ø¨
                renderBook();
                renderTOC();
                displaySection(0);

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨:', error);
                document.getElementById('book-content').innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">ğŸ“š</div>
                        <h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨</h3>
                        <a href="/" class="btn btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    </div>
                `;
            }
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨
        function renderBook() {
            document.title = `${book.title} - Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©`;
            document.getElementById('book-title-mini').textContent = book.title;
            document.getElementById('breadcrumb-book').textContent = book.title;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ÙÙ‡Ø±Ø³
        function renderTOC() {
            const tocContainer = document.getElementById('book-toc');
            const tocHTML = '<ul class="toc">' + book.chapters.map((chapter, chapterIndex) => `
                <li class="toc-chapter ${chapterIndex === 0 ? 'expanded' : ''}" data-chapter-id="${chapter.id}">
                    <div class="toc-chapter-title ${chapterIndex === 0 ? 'expanded' : ''}" onclick="toggleChapter('${chapter.id}')">
                        <span>${chapter.title}</span>
                        <span style="font-size: 0.875rem;">${chapterIndex === 0 ? 'â–¼' : 'â—„'}</span>
                    </div>
                    <ul class="toc-sections">
                        ${chapter.sections.map((section, sectionIndex) => {
                            const globalIndex = allSections.findIndex(s => s.id === section.id);
                            return `
                                <li class="toc-section" onclick="displaySection(${globalIndex})">
                                    ${section.title}
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </li>
            `).join('') + '</ul>';

            tocContainer.innerHTML = tocHTML;
        }

        // ØªØ¨Ø¯ÙŠÙ„ ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙØµÙ„
        function toggleChapter(chapterId) {
            const chapter = document.querySelector(`[data-chapter-id="${chapterId}"]`);
            const title = chapter.querySelector('.toc-chapter-title');
            const arrow = title.querySelector('span:last-child');

            if (chapter.classList.contains('expanded')) {
                chapter.classList.remove('expanded');
                title.classList.remove('expanded');
                arrow.textContent = 'â—„';
            } else {
                chapter.classList.add('expanded');
                title.classList.add('expanded');
                arrow.textContent = 'â–¼';
            }
        }

        // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ†
        function displaySection(index) {
            if (index < 0 || index >= allSections.length) return;

            currentSectionIndex = index;
            const section = allSections[index];

            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³
            document.querySelectorAll('.toc-section').forEach((el, i) => {
                if (i === index) {
                    el.classList.add('active');
                    // ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    const chapterEl = el.closest('.toc-chapter');
                    if (chapterEl && !chapterEl.classList.contains('expanded')) {
                        const chapterId = chapterEl.getAttribute('data-chapter-id');
                        toggleChapter(chapterId);
                    }
                } else {
                    el.classList.remove('active');
                }
            });

            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
            let content = section.content;
            content = content.replace(/Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…/g, '<span style="color: var(--islamic-gold); font-weight: 600;">Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…</span>');
            content = content.replace(/ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ¢Ù„Ù‡/g, '<span style="color: var(--islamic-gold); font-weight: 600;">ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ¢Ù„Ù‡</span>');
            content = content.replace(/ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù…/g, '<span style="color: var(--islamic-gold); font-weight: 600;">ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù…</span>');
            content = content.replace(/Â«\s*(\d+)\s*Â»/g, '<sup style="font-size: 0.7em;">[â€$1â€]</sup>');

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            document.getElementById('book-content').innerHTML = `
                <div class="content-header">
                    <h1 class="content-title">${section.title}</h1>
                    <div class="content-meta">
                        <span>${section.chapterTitle}</span>
                        <span>â€¢</span>
                        <span>ØµÙØ­Ø© ${index + 1} Ù…Ù† ${allSections.length}</span>
                    </div>
                </div>

                <div class="content-body" id="content-body" style="font-size: ${fontSize}rem;">
                    ${content}
                </div>

                <div class="content-navigation">
                    <button class="btn btn-secondary" onclick="displaySection(${index - 1})" ${index === 0 ? 'disabled' : ''}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Ø§Ù„Ø³Ø§Ø¨Ù‚
                    </button>

                    <button class="btn btn-secondary" onclick="displaySection(${index + 1})" ${index === allSections.length - 1 ? 'disabled' : ''}>
                        Ø§Ù„ØªØ§Ù„ÙŠ
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
            `;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
            updateProgress();

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            if (window.innerWidth <= 992) {
                document.getElementById('book-sidebar').classList.remove('open');
            }

            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
            window.scrollTo(0, 0);
        }

        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        function updateProgress() {
            const progress = Math.round(((currentSectionIndex + 1) / allSections.length) * 100);
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
            document.getElementById('reading-progress-bar').style.width = progress + '%';
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…
        document.getElementById('theme-toggle').addEventListener('click', function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
        document.querySelectorAll('[data-action="toggle-sidebar"]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('book-sidebar').classList.toggle('open');
            });
        });

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
        document.getElementById('font-decrease').addEventListener('click', function() {
            fontSize = Math.max(0.875, fontSize - 0.125);
            const contentBody = document.getElementById('content-body');
            if (contentBody) {
                contentBody.style.fontSize = fontSize + 'rem';
            }
        });

        document.getElementById('font-increase').addEventListener('click', function() {
            fontSize = Math.min(2, fontSize + 0.125);
            const contentBody = document.getElementById('content-body');
            if (contentBody) {
                contentBody.style.fontSize = fontSize + 'rem';
            }
        });

        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰/Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        document.getElementById('goto-first').addEventListener('click', () => displaySection(0));
        document.getElementById('goto-last').addEventListener('click', () => displaySection(allSections.length - 1));

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadBook();

        // ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø± Ø§Ù„ÙŠÙ…ÙŠÙ† =====
        let selectedText = '';
        const contextMenu = document.getElementById('contextMenu');

        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø± Ø§Ù„ÙŠÙ…ÙŠÙ†
        document.addEventListener('contextmenu', function(e) {
            const selection = window.getSelection().toString().trim();

            if (selection && selection.length > 0) {
                e.preventDefault();
                selectedText = selection;

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù…Ù‡Ø§
                contextMenu.style.display = 'block';
                contextMenu.style.visibility = 'hidden';

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
                const menuRect = contextMenu.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø³ØªØ®Ø±Ø¬ Ù…Ù† Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©ØŒ Ø§Ø¸Ù‡Ø±Ù‡Ø§ ÙÙˆÙ‚ Ø§Ù„Ù…Ø¤Ø´Ø±
                if (window.innerHeight - y < menuRect.height) {
                    contextMenu.style.top = (y + window.scrollY - menuRect.height - 5) + 'px';
                } else {
                    contextMenu.style.top = (y + window.scrollY + 5) + 'px';
                }

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø³ØªØ®Ø±Ø¬ Ù…Ù† ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©ØŒ Ø§Ø¸Ù‡Ø±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
                if (window.innerWidth - x < menuRect.width) {
                    contextMenu.style.left = (x + window.scrollX - menuRect.width - 5) + 'px';
                } else {
                    contextMenu.style.left = (x + window.scrollX + 5) + 'px';
                }

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                contextMenu.style.visibility = 'visible';
            }
        });

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
        document.addEventListener('click', function() {
            contextMenu.style.display = 'none';
        });

        // ===== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Øµ =====
        function searchSelectedText() {
            document.getElementById('searchTextInput').value = selectedText;
            document.getElementById('textFinderModal').style.display = 'flex';
            contextMenu.style.display = 'none';
            performTextSearch();
        }

        function closeTextFinder() {
            document.getElementById('textFinderModal').style.display = 'none';
        }

        async function performTextSearch() {
            const query = document.getElementById('searchTextInput').value;
            if (!query || query.trim().length < 2) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„Ø¨Ø­Ø«');
                return;
            }

            const resultsContainer = document.getElementById('textFinderResults');
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p></div>';

            try {
                const response = await fetch('/api/search-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«');
                }

                if (data.results && data.results.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="results-header">
                            <p>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.count} Ù†ØªÙŠØ¬Ø©</p>
                        </div>
                        <div class="results-list">
                            ${data.results.map(result => `
                                <div class="result-item">
                                    <h4><a href="/book.html?id=${result.bookId}">${result.bookTitle}</a></h4>
                                    <p class="result-meta">${result.bookAuthor} â€¢ ${result.categoryName}</p>
                                    <p class="result-chapter">${result.chapterTitle}</p>
                                    <p class="result-excerpt">${result.context}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '<div class="no-results"><p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬</p></div>';
                }
            } catch (error) {
                console.error('Error searching text:', error);
                resultsContainer.innerHTML = `<div class="error-message"><p>Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</p></div>`;
            }
        }

        // ===== Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø°ÙƒÙŠ =====
        function smartFetchSelected() {
            document.getElementById('smartFetchInput').value = selectedText;
            document.getElementById('smartFetchModal').style.display = 'flex';
            contextMenu.style.display = 'none';
            performSmartFetch();
        }

        function closeSmartFetch() {
            document.getElementById('smartFetchModal').style.display = 'none';
        }

        async function performSmartFetch() {
            const query = document.getElementById('smartFetchInput').value;
            if (!query || query.trim().length < 3) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ù…ÙˆØ¶ÙˆØ¹ Ù„Ù„Ø¨Ø­Ø«');
                return;
            }

            const resultsContainer = document.getElementById('smartFetchResults');
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ...</p></div>';

            try {
                const response = await fetch('/api/smart-fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, limit: 10 })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«');
                }

                if (data.results && data.results.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="results-header">
                            <p>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.count} Ù†ØªÙŠØ¬Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ${data.keywords.join(', ')}</p>
                        </div>
                        <div class="results-list">
                            ${data.results.map(result => `
                                <div class="result-item">
                                    <h4><a href="/book.html?id=${result.bookId}">${result.bookTitle}</a></h4>
                                    <p class="result-meta">${result.bookAuthor} â€¢ ${result.categoryName}</p>
                                    <p class="result-chapter">${result.chapterTitle} - ${result.sectionTitle}</p>
                                    <p class="result-excerpt">${result.excerpt}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = '<div class="no-results"><p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬</p></div>';
                }
            } catch (error) {
                console.error('Error in smart fetch:', error);
                resultsContainer.innerHTML = `<div class="error-message"><p>Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</p></div>`;
            }
        }

        // ===== Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ© =====
        let chatContext = [];

        function openAIChatWithText() {
            if (selectedText) {
                document.getElementById('aiChatInput').value = `Ø§Ø´Ø±Ø­ Ù„ÙŠ: "${selectedText}"`;
            }
            document.getElementById('aiChatModal').style.display = 'flex';
            contextMenu.style.display = 'none';
        }

        function closeAIChat() {
            document.getElementById('aiChatModal').style.display = 'none';
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();

            if (!message) return;

            const messagesContainer = document.getElementById('aiChatMessages');

            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            messagesContainer.innerHTML += `
                <div class="chat-message user-message">
                    <div class="message-content">${message}</div>
                </div>
            `;

            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
            messagesContainer.innerHTML += `
                <div class="chat-message ai-message loading-message">
                    <div class="message-content">
                        <div class="spinner-small"></div>
                        <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...</span>
                    </div>
                </div>
            `;

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            input.value = '';

            try {
                const response = await fetch('/api/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, context: chatContext })
                });

                const data = await response.json();

                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                const loadingMsg = messagesContainer.querySelector('.loading-message');
                if (loadingMsg) loadingMsg.remove();

                if (!response.ok) {
                    throw new Error(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ');
                }

                // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                let aiReply = `<div class="message-content">${data.reply}</div>`;

                if (data.sources && data.sources.length > 0) {
                    aiReply += '<div class="message-sources"><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø±:</strong><ul>';
                    data.sources.forEach(source => {
                        aiReply += `<li><a href="/book.html?id=${source.bookId}">${source.bookTitle} - ${source.chapterTitle}</a></li>`;
                    });
                    aiReply += '</ul></div>';
                }

                messagesContainer.innerHTML += `
                    <div class="chat-message ai-message">
                        ${aiReply}
                    </div>
                `;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ§Ù‚
                chatContext.push({ role: 'user', content: message });
                chatContext.push({ role: 'assistant', content: data.reply });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Error in AI chat:', error);

                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                const loadingMsg = messagesContainer.querySelector('.loading-message');
                if (loadingMsg) loadingMsg.remove();

                messagesContainer.innerHTML += `
                    <div class="chat-message ai-message error-message">
                        <div class="message-content">Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</div>
                    </div>
                `;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // ===== Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© =====
        function addBookmark() {
            const section = allSections[currentSectionIndex];

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
            let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
            const exists = bookmarks.some(b => b.bookId === bookId && b.sectionId === section.id);

            if (exists) {
                alert('Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            bookmarks.push({
                bookId: bookId,
                bookTitle: book.title,
                sectionId: section.id,
                sectionTitle: section.title,
                chapterTitle: section.chapterTitle,
                addedAt: new Date().toISOString()
            });

            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));

            alert('âœ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
            contextMenu.style.display = 'none';
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
