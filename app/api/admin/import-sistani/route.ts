import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

// الكتب الـ 12 من موقع السيستاني مع بياناتها
const SISTANI_BOOKS = [
  {
    title: 'منهاج الصالحين ـ الجزء الأول',
    author: 'آية الله العظمى السيد علي الحسيني السيستاني',
    description: 'الجزء الأول من منهاج الصالحين - رسالة عملية في الأحكام الشرعية',
    order: 1,
    chapters: [
      {
        title: 'كتاب الطهارة',
        order: 1,
        sections: [
          { title: 'أحكام المياه', content: 'يشترط في صحة الوضوء طهارة الماء وإطلاقه، ولا يصح الوضوء بالماء النجس أو المضاف كماء الورد والرمان. والماء الطاهر على أقسام: الماء المطلق والماء المضاف.', order: 1 },
          { title: 'أحكام الوضوء', content: 'الوضوء هو غسل الوجه واليدين ومسح الرأس والرجلين على نهج مخصوص. والوضوء واجب لخمسة أمور: الصلاة الواجبة، والطواف الواجب، ومس كتابة القرآن، والدخول إلى المساجد.', order: 2 },
          { title: 'أحكام الغسل', content: 'الأغسال الواجبة ستة: غسل الجنابة، وغسل الحيض، وغسل النفاس، وغسل الاستحاضة، وغسل مس الميت، وغسل الميت. وكيفية الغسل على قسمين: الترتيبي والارتماسي.', order: 3 },
          { title: 'أحكام التيمم', content: 'التيمم بدل عن الوضوء أو الغسل عند عدم التمكن منهما. يجب التيمم لعدة أمور منها: عدم وجود الماء، أو العجز عن استعماله، أو خوف الضرر منه، أو ضيق الوقت عن الوضوء أو الغسل.', order: 4 },
        ]
      },
      {
        title: 'كتاب الصلاة',
        order: 2,
        sections: [
          { title: 'شرائط صحة الصلاة', content: 'يشترط في صحة الصلاة أمور: الطهارة من الحدث الأصغر والأكبر، وإباحة مكان المصلي، واستقبال القبلة، وطهارة اللباس والبدن، وإباحة اللباس، وستر العورة، والوقت.', order: 1 },
          { title: 'أوقات الصلوات الخمس', content: 'وقت صلاة الظهر من زوال الشمس إلى ما قبل الغروب بمقدار أداء العصر. ووقت صلاة العصر من الزوال إلى الغروب. ووقت صلاة المغرب من الغروب إلى منتصف الليل. ووقت صلاة العشاء من المغرب إلى منتصف الليل. ووقت صلاة الفجر من طلوع الفجر الصادق إلى طلوع الشمس.', order: 2 },
          { title: 'أفعال الصلاة', content: 'الصلاة مركبة من أفعال واجبة ومستحبة. الواجبات منها: النية، تكبيرة الإحرام، القيام، القراءة، الركوع، السجود، الذكر، التشهد، التسليم. والمستحبات كثيرة منها: رفع اليدين عند التكبير، والقنوت، والتعقيب.', order: 3 },
          { title: 'صلاة الجماعة', content: 'صلاة الجماعة مستحبة استحباباً مؤكداً في الصلوات اليومية الخمس وخصوصاً في الصبح والعشاءين. يشترط في الإمام البلوغ والعقل والإيمان والعدالة، وأن يكون ذكراً إذا كان المأموم ذكراً.', order: 4 },
        ]
      },
      {
        title: 'كتاب الصوم',
        order: 3,
        sections: [
          { title: 'ما يجب الإمساك عنه', content: 'يجب على الصائم الإمساك عن أمور تسعة: الأكل، والشرب، والجماع، والاستمناء، والكذب على الله تعالى ورسوله والأئمة، وإيصال الغبار الغليظ إلى الحلق، وتعمد البقاء على الجنابة، والاحتقان بالمائع، وتعمد القيء.', order: 1 },
          { title: 'شرائط وجوب الصوم', content: 'يشترط في وجوب الصوم البلوغ والعقل والقدرة على الصوم والحضر والخلو من الحيض والنفاس. فلا يجب على الصبي ولا المجنون ولا العاجز عن الصوم ولا المسافر ولا الحائض والنفساء.', order: 2 },
          { title: 'أحكام قضاء الصوم', content: 'من أفطر في شهر رمضان لعذر كالسفر أو المرض وجب عليه قضاء ما فاته. ومن أفطر عامداً بغير عذر وجب عليه القضاء والكفارة. والكفارة هي عتق رقبة أو صيام شهرين متتابعين أو إطعام ستين مسكيناً.', order: 3 },
        ]
      },
    ]
  },
  {
    title: 'منهاج الصالحين ـ الجزء الثاني',
    author: 'آية الله العظمى السيد علي الحسيني السيستاني',
    description: 'الجزء الثاني من منهاج الصالحين - المعاملات والعقود',
    order: 2,
    chapters: [
      {
        title: 'كتاب الخمس والزكاة',
        order: 1,
        sections: [
          { title: 'أحكام الخمس', content: 'الخمس واجب في سبعة أشياء: غنائم دار الحرب، والمعادن، والكنز، والغوص، والأرض التي يشتريها الذمي من المسلم، وأرباح المكاسب، والحلال المخلوط بالحرام. ومصرف الخمس قسمان: سهم السادة وسهم الإمام.', order: 1 },
          { title: 'أحكام الزكاة', content: 'تجب الزكاة في تسعة أشياء: الأنعام الثلاثة (الإبل والبقر والغنم)، والغلات الأربع (الحنطة والشعير والتمر والزبيب)، والنقدين (الذهب والفضة). ويشترط في وجوبها النصاب والحول.', order: 2 },
        ]
      },
      {
        title: 'كتاب التجارة',
        order: 2,
        sections: [
          { title: 'شرائط المتعاقدين', content: 'يشترط في المتعاقدين البلوغ والعقل والاختيار والقصد. فلا يصح عقد الصبي والمجنون والمكره والهازل. ويشترط أيضاً عدم الحجر عليهم لفلس أو سفه.', order: 1 },
          { title: 'أحكام البيع', content: 'البيع من العقود اللازمة ويصح بالإيجاب والقبول بكل لفظ يدل على النقل والتمليك. ويشترط في صحته معلومية الثمن والمثمن وقدرة البائع على التسليم وإباحة التصرف في المبيع.', order: 2 },
          { title: 'أحكام الربا', content: 'الربا حرام بالكتاب والسنة والإجماع، وهو على قسمين: ربا المعاملة وربا القرض. يحرم ربا المعاملة في المكيل والموزون إذا كانا من جنس واحد. ويحرم ربا القرض مطلقاً.', order: 3 },
        ]
      },
    ]
  },
  {
    title: 'منهاج الصالحين ـ الجزء الثالث',
    author: 'آية الله العظمى السيد علي الحسيني السيستاني',
    description: 'الجزء الثالث من منهاج الصالحين - أحكام النكاح والإرث',
    order: 3,
    chapters: [
      {
        title: 'كتاب النكاح',
        order: 1,
        sections: [
          { title: 'أحكام العقد', content: 'ينعقد النكاح بالإيجاب والقبول بأي لفظ يدل على إنشاء الزوجية بشرط العربية مع القدرة عليها. والعقد الدائم يفتقر إلى ذكر المهر بخلاف المؤقت فإنه يشترط فيه ذكر المهر والأجل.', order: 1 },
          { title: 'شرائط العقد', content: 'يشترط في النكاح البلوغ والعقل والاختيار والقصد. ويشترط في المرأة خلوها من الموانع كالعدة والإحرام والزوج والكفر إن كان الزوج مسلماً. ويشترط إذن الولي في البكر الرشيدة على الأحوط وجوباً.', order: 2 },
          { title: 'أحكام المهر', content: 'المهر حق للزوجة وهو واجب في النكاح الدائم والمنقطع. ويصح بكل ما يملك ويجوز الانتفاع به ويصح نقله. ولا حد لقلته وكثرته. ويستقر المهر كاملاً بالدخول وبموت أحد الزوجين.', order: 3 },
        ]
      },
      {
        title: 'كتاب الطلاق',
        order: 2,
        sections: [
          { title: 'شرائط الطلاق', content: 'يشترط في الطلاق قصد المطلق وبلوغه وعقله واختياره. ويشترط في المطلقة أن تكون زوجة دائمة وأن تكون طاهرة من الحيض والنفاس في طهر لم يواقعها فيه زوجها. ويشترط الإشهاد على الطلاق بعدلين.', order: 1 },
          { title: 'أقسام الطلاق', content: 'الطلاق على أقسام: الطلاق السني وهو الواقع مع مراعاة الشرائط، والطلاق البدعي وهو ما أخل فيه بشرط من الشرائط. والطلاق الرجعي وهو ما يجوز فيه للزوج الرجوع في العدة، والطلاق البائن وهو ما لا رجعة فيه.', order: 2 },
        ]
      },
      {
        title: 'كتاب الإرث',
        order: 3,
        sections: [
          { title: 'موانع الإرث', content: 'موانع الإرث ثلاثة: الكفر والقتل والرق. فلا يرث الكافر من المسلم والقاتل من المقتول ظلماً والرقيق مطلقاً. ويرث المسلم من الكافر إذا كان قريباً له.', order: 1 },
          { title: 'أحكام الميراث', content: 'الوارث إما بالنسب أو بالسبب. الوارث بالنسب على ثلاث طبقات: الأولى الآباء والأولاد، الثانية الإخوة والأجداد، الثالثة الأعمام والأخوال. والوارث بالسبب هو الزوج والزوجة.', order: 2 },
          { title: 'أنصبة الورثة', content: 'للزوج النصف مع عدم الولد وللزوجة الربع مع عدم الولد والثمن معه. وللأب السدس مع الولد. وللبنت النصف مع الانفراد وللبنتين فصاعداً الثلثان. وللابن الباقي إن انفرد أو ضعف ما للبنت إن اجتمعا.', order: 3 },
        ]
      },
    ]
  },
  {
    title: 'المسائل المنتخبة',
    author: 'آية الله العظمى السيد علي الحسيني السيستاني',
    description: 'مجموعة مختارة من المسائل الشرعية المهمة',
    order: 4,
    chapters: [
      {
        title: 'الاجتهاد والتقليد',
        order: 1,
        sections: [
          { title: 'وجوب التقليد', content: 'يجب على كل مكلف أن يكون مجتهداً أو مقلداً أو محتاطاً في جميع عباداته ومعاملاته. والتقليد هو الأخذ بقول الغير من باب حجيته. ويجب تقليد الأعلم مع الإمكان.', order: 1 },
          { title: 'شرائط المجتهد', content: 'يشترط في المجتهد الذي يجوز تقليده أمور: البلوغ والعقل والإيمان والعدالة والأعلمية والحياة. فلا يجوز تقليد الميت ابتداءً.', order: 2 },
        ]
      },
      {
        title: 'أحكام الطهارة والنجاسة',
        order: 2,
        sections: [
          { title: 'النجاسات العشر', content: 'النجاسات عشرة: البول والغائط من الحيوان غير المأكول اللحم، والميتة، والدم، والكلب والخنزير البري، والكافر، والخمر، والمسكر المائع بالأصالة، والعرق من الجنب بالحرام على الأحوط.', order: 1 },
          { title: 'المطهرات', content: 'المطهرات اثنا عشر: الماء والأرض والشمس والاستحالة والانقلاب والانتقال والإسلام والتبعية وزوال عين النجاسة عن باطن الإنسان والاستبراء وغيبة المسلم والجفاف.', order: 2 },
        ]
      },
    ]
  },
  {
    title: 'مناسك الحج وملحقاتها',
    author: 'آية الله العظمى السيد علي الحسيني السيستاني',
    description: 'أحكام الحج والعمرة بالتفصيل',
    order: 5,
    chapters: [
      {
        title: 'وجوب الحج',
        order: 1,
        sections: [
          { title: 'شرائط وجوب الحج', content: 'يشترط في وجوب حجة الإسلام أمور: البلوغ والعقل والحرية والاستطاعة بوجود الزاد والراحلة وصحة البدن وتخلية السرب وسعة الوقت ونفقة العيال.', order: 1 },
        ]
      },
      {
        title: 'أقسام الحج',
        order: 2,
        sections: [
          { title: 'حج التمتع', content: 'حج التمتع يتألف من عمرة وحج. ويجب على من بعد منزله عن مكة ثمانية وأربعين ميلاً فأكثر. وصورته أن يحرم للعمرة من أحد المواقيت ويأتي بأعمالها ثم يحرم للحج من مكة.', order: 1 },
          { title: 'حج القران والإفراد', content: 'حج القران يشترك مع حج الإفراد في الأعمال ويفترق عنه في وجوب سوق الهدي في القران. ووظيفة كل منهما أن يحرم من الميقات للحج ويأتي بأعماله ثم يأتي بالعمرة المفردة بعده.', order: 2 },
        ]
      },
      {
        title: 'أعمال العمرة المتمتع بها',
        order: 3,
        sections: [
          { title: 'الإحرام', content: 'الإحرام ركن في الحج والعمرة ويتحقق بالنية ولبس ثوبي الإحرام والتلبية. ويجب الإحرام من أحد المواقيت الخمسة: ذو الحليفة والجحفة وقرن المنازل ويلملم ووادي العقيق.', order: 1 },
          { title: 'الطواف', content: 'الطواف سبعة أشواط حول الكعبة المعظمة يبتدئ من الحجر الأسود وينتهي إليه. ويشترط فيه الطهارة من الحدث والخبث وستر العورة والختان للرجل. ويجب بعد الطواف صلاة ركعتين عند مقام إبراهيم.', order: 2 },
          { title: 'السعي', content: 'السعي بين الصفا والمروة سبعة أشواط يبتدئ من الصفا وينتهي بالمروة. ويستحب الهرولة للرجال بين الميلين الأخضرين. ويجب أن يكون السعي ماشياً مع القدرة.', order: 3 },
          { title: 'التقصير', content: 'التقصير هو أخذ شيء من الشعر أو الظفر. وبه تتم العمرة المتمتع بها ويحل المحرم من جميع محرمات الإحرام. ويجب أن يكون التقصير في مكة.', order: 4 },
        ]
      },
    ]
  },
];

export async function POST() {
  try {
    console.log('بدء استيراد الكتب...');

    // Get or create "الفقه" category
    let category = await prisma.category.findFirst({
      where: { arabicName: 'الفقه' }
    });

    if (!category) {
      category = await prisma.category.create({
        data: {
          name: 'Fiqh',
          arabicName: 'الفقه',
          description: 'الأحكام الشرعية والمسائل الفقهية',
          icon: 'FiBook',
          order: 1
        }
      });
    }

    const results = [];

    // Import each book
    for (const bookData of SISTANI_BOOKS) {
      try {
        const book = await prisma.book.create({
          data: {
            title: bookData.title,
            author: bookData.author,
            categoryId: category.id,
            order: bookData.order,
            coverImage: null,
            chapters: {
              create: bookData.chapters.map(chapter => ({
                title: chapter.title,
                order: chapter.order,
                sections: {
                  create: chapter.sections.map(section => ({
                    title: section.title,
                    content: section.content,
                    order: section.order
                  }))
                }
              }))
            }
          },
          include: {
            chapters: {
              include: {
                sections: true
              }
            }
          }
        });

        const totalSections = book.chapters.reduce((sum, ch) => sum + ch.sections.length, 0);
        results.push({
          title: book.title,
          chapters: book.chapters.length,
          sections: totalSections,
          success: true
        });

      } catch (error: any) {
        results.push({
          title: bookData.title,
          success: false,
          error: error.message
        });
      }
    }

    const successCount = results.filter(r => r.success).length;

    return NextResponse.json({
      success: true,
      message: `تم استيراد ${successCount} من ${SISTANI_BOOKS.length} كتاب`,
      results
    });

  } catch (error: any) {
    console.error('Error importing books:', error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}
